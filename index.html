<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AUSTRETEN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- CSS -->
  <link rel="stylesheet" href="styles/styles.css" />
</head>

<body>

<header>
  <span class="title">austreten</span>
</header>

<main class="app">

  <!-- MAP + PROGRESS -->
  <section class="map-area">
    <div class="p-4 p-md-5 mb-4 rounded text-body-emphasis bg-body-secondary">
      <div class="container-fluid">
        <div class="row">
          <!-- Progress / Ladebalken -->
          <div class="col-md-8 mx-auto mb-3">
            <div id="visitCount" class="text-center fw-semibold mb-2">Ausgetreten: 0 / 0</div>
            <div class="progress" role="progressbar" aria-label="Besuchsfortschritt" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 24px;">
              <div id="visitProgressBar" class="progress-bar" style="width: 0%;">0%</div>
            </div>
          </div>

          <!-- Map Column -->
          <div class="col-md-8 mx-auto" id="map" style="height: 800px;"></div>  
        </div>
      </div>
    </div>
  </section>

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <!-- SEARCH -->
    <input type="text" id="searchInput" placeholder="Suchen" autocomplete="off" />


    <!-- INFO PANEL -->
    <div class="popup-panel" id="popupPanel">
      <img id="locationImage" src="" alt="">
      <div class="popup-text">
        <h2 id="locationTitle">Ort wählen</h2>
        <p id="locationDescription"></p>
        <p id="locationMeta"></p>
      </div>
    </div>

  </aside>

  <!-- LINE -->
  <svg id="connector-layer"></svg>

</main>

<!-- LOCATIONS -->
<script src="kirchen_evangelisch.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const map = L.map("map").setView([52.52, 13.405], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: ""
  }).addTo(map);

  const markers = [];
  const panel = document.getElementById("popupPanel");
  const svg = document.getElementById("connector-layer");
  const progressBar = document.getElementById("visitProgressBar");

  const baseIcon = {
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [0, -32],
    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
    shadowSize: [41, 41]
  };

  const greenIcon = new L.Icon({
    ...baseIcon,
    iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-green.png"
  });

  const redIcon = new L.Icon({
    ...baseIcon,
    iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png"
  });

  function isBesucht(val) {
    if (val === true) return true;
    if (val === false || val == null) return false;
    const s = String(val).trim().toLowerCase();
    return s === "ja" || s === "yes" || s === "true" || s === "1";
  }

  function updateVisitProgress() {
    const total = locations.length;
    const visited = locations.filter(l => isBesucht(l.besucht)).length;
    const percent = total ? Math.round((visited / total) * 100) : 0;

    const countEl = document.getElementById('visitCount');
    const barEl = document.getElementById('visitProgressBar');

    if (countEl) countEl.textContent = `Besucht: ${visited} / ${total}`;
    if (barEl) {
      barEl.style.width = percent + '%';
      barEl.textContent = percent + '%';
      barEl.parentElement?.setAttribute('aria-valuenow', String(percent));
    }
  }

  updateVisitProgress();

  // MARKER ERSTELLEN
  locations.forEach(loc => {
    const icon = isBesucht(loc.besucht) ? greenIcon : redIcon;
    const marker = L.marker(loc.coords, { icon }).addTo(map);
    marker._data = loc;
    markers.push(marker);

    marker.on("click", () => showLocation(marker));
  });

  function showLocation(marker) {
    const d = marker._data;

    panel.classList.add("active");
    locationImage.src = d.img || "";
    locationTitle.textContent = d.title || "";
    locationDescription.textContent = d.description || "";
    locationMeta.textContent =
      `${d.date || ""} · ${d.time || ""} · ${d.weather || ""}`;

    drawLine(marker);
  }

  function drawLine(marker) {
    svg.innerHTML = "";

    const mapPoint = map.latLngToContainerPoint(marker.getLatLng());
    const img = document.getElementById("locationImage");
    const imgRect = img.getBoundingClientRect();

    const x1 = mapPoint.x;
    const y1 = mapPoint.y;
    const x2 = imgRect.left;
    const y2 = imgRect.top + imgRect.height / 2;

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#ffffff");
    line.setAttribute("stroke-width", "1");

    svg.appendChild(line);
  }

  // SUCHE
  const searchInput = document.getElementById("searchInput");
const autocompleteList = document.getElementById("autocomplete-list");

searchInput.addEventListener("input", () => {
  const val = searchInput.value.toLowerCase();
  autocompleteList.innerHTML = "";

  if (!val) return;

  const matches = locations
    .filter(loc => loc.title.toLowerCase().includes(val))
    .map(loc => loc.title);

  matches.forEach(title => {
    const li = document.createElement("li");
    li.textContent = title;
    li.addEventListener("click", () => selectTitle(title));
    autocompleteList.appendChild(li);
  });
});

searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const first = autocompleteList.querySelector("li");
    if (first) selectTitle(first.textContent);
  }
});

function selectTitle(title) {
  autocompleteList.innerHTML = "";
  searchInput.value = title;

  const marker = markers.find(m => m._data.title === title);
  if (marker) {
    map.setView(marker.getLatLng(), 15);
    showLocation(marker);
  }
}


});
</script>

</body>
</html>
